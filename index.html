<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic tac toe</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js'
        import { getDatabase, ref, set, get, child, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDZyoC-z8QaD5zaNQCo6h_16q7prBFpqF4",
            authDomain: "test-project-wiktor.firebaseapp.com",
            databaseURL: "https://test-project-wiktor-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "test-project-wiktor",
            storageBucket: "test-project-wiktor.appspot.com",
            messagingSenderId: "1023581352441",
            appId: "1:1023581352441:web:85672eb52848bc48734d28",
            measurementId: "G-CC08PXCR5C"
        };//Podobno przechowywanie tego tutaj jest bezpieczne. Podobno.
                        
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(); 

        var isLogged = false;
        
        const logIn = async() => {
            const login=document.getElementById("userEmail").value;
            const password = document.getElementById("userPassword").value;
            try{
                const userCredential = await signInWithEmailAndPassword(auth, login, password)
                console.log(userCredential.user);
            }catch(error){
                console.log(error.code);
            }
            
        }

        const signUp = async() => {
            const login = document.getElementById("userEmail").value;
            const password = document.getElementById("userPassword").value;
            try{
                const userCredential = await createUserWithEmailAndPassword(auth, login, password)
                console.log(userCredential.user);
            }catch(error){
                console.log(error.code);
            } 
        }

        const monitorAuth = async() => {
            onAuthStateChanged(auth, user=>{
                if(user){
                    isLogged=true;
                    console.log("zalogowany");
                }else{
                    isLogged=false;
                    console.log("nie zalogowany");
                }
            });
        }

        const logOut = async() => {
            await signOut(auth);
        }

        function ShowError(errorMessage){
            document.getElementById("errorJoining").style.display="inline";
            document.getElementById("errorJoining").textContent=errorMessage;
        }

        const generateCode = async() => {
            if(!isLogged){
                ShowError("Zaloguj sie lub zarejestruj!");
                return;
            }
            var generatedCode="";
            const charset = 'abcdefghijklmnopqrstuvwxyz0123456789';
            for (let i = 0; i < 6; i++) {
                generatedCode += charset.charAt(Math.floor(Math.random() * charset.length));
            }
            const database = getDatabase(app);
            const reference = ref(database, 'games/' + generatedCode);
            set(reference, {
                fields: "000000000"
            });
            document.getElementById("wygenerowanyCode").textContent="Twoj kod gry: " + generatedCode;
            document.getElementById("joiningMenu").style.display="none";
            watchGame(generatedCode);
        }

        const joinGame = async() => {
            if(!isLogged){
                ShowError("Zaloguj sie lub zarejestruj!");
                return;
            }
            var gameCode = document.getElementById("JoinGameInput").value;
            const dbRef = ref(getDatabase(app));
            get(child(dbRef, 'games/' + gameCode)).then((snapshot)=>{
                if(snapshot.exists() && snapshot.val().fields != undefined){
                    document.getElementById("joiningMenu").style.display="none";
                    document.getElementById("testDaneZBazy").textContent=snapshot.val().fields;
                    console.log(snapshot.val().fields);
                    watchGame(gameCode);
                }
                else{
                    ShowError("Błędny kod gry!");
                }
            });
        }

        function watchGame(gameCode){
            document.getElementById("joinGameButton").disabled=true;
            document.getElementById("generateCodeButton").disabled=true;
            const db = getDatabase(app);
            const distanceRef = ref(db, 'games/' + gameCode);
            onValue(distanceRef, (snapshot) => {
                //ChangeGameState(snapshot.val().fields); dodac logike do zmiany pol na planszy
                document.getElementById("testDaneZBazy").textContent=snapshot.val().fields;

            });
        }
        
        monitorAuth();
        document.getElementById("signInUser").addEventListener("click", logIn);
        document.getElementById("signUpUser").addEventListener("click", signUp);
        document.getElementById("logOutUser").addEventListener("click",logOut);
        document.getElementById("generateCodeButton").addEventListener("click",generateCode);
        document.getElementById("joinGameButton").addEventListener("click",joinGame)
    </script>
      
</head>
<body>
    <div style="display: inline-flex; width:100%">
        <div style="justify-content: space-between; display: flex; border: 1px solid black; padding: 20px; width: 100%;">
            <div>
                <label for="userEmail">Email:</label>
                <input type="text" id="userEmail">
            </div>
            <div>
                <label for="userPassword">Haslo:</label>
                <input type="text" id="userPassword">
            </div>
            <button id="signUpUser">Zarejestruj się</button>
            <button id="signInUser">Zaloguj się</button>
            <button id="logOutUser">wyloguj</button>
        </div>
    </div>
    <div id="joiningMenu" style=" border: 1px solid black; padding: 10px; margin-top: 10px;">
        <button id="generateCodeButton">Zacznij gre</button>
        <button id="joinGameButton">Dolacz do gry</button>
        <label for="JoinGameInput">Kod gry:</label>
        <input type="text" id="JoinGameInput">
        <p id="errorJoining" style="display:none;">Error!</p>
    </div>
    <div style="font-size: 20px; margin-top: 20px;" id="wygenerowanyCode"></div>

    <p id="testDaneZBazy"></p>
</body>
</html>